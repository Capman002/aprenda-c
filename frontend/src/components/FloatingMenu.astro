---
import Icon from './Icon.astro';
import { SITE, NAVIGATION } from '../site.config';

const pathname = Astro.url.pathname;
const isActive = (path: string) => {
  if (path === '/') return pathname === '/';
  if (path.length > 1 && pathname.startsWith(path)) return true;
  return false;
};
---

<nav class="floating-menu">
  <div class="menu-pill">
    <div class="links">
        <!-- Home Link (Manual for Icon) -->
      <a href="/" class={`nav-link ${isActive('/') ? 'active' : ''}`} data-astro-prefetch>
        <Icon name="home" size={16} /> IN√çCIO
      </a>
      
      <!-- Dynamic Navigation -->
      {NAVIGATION.map(item => {
        // Skip GitHub as we treat it specially with icon or allow it if desired. 
        // For now I'll check label to map icons manually or generic
        let icon = "circle";
        if (item.label === "Curso") icon = "graduation-cap";
        if (item.label === "Playground") icon = "terminal";
        if (item.label === "GitHub") return null; // Handle manually below

        return (
            <a href={item.href} class={`nav-link ${isActive(item.href) ? 'active' : ''}`} data-astro-prefetch>
                <Icon name={icon} size={16} /> {item.label.toUpperCase()}
            </a>
        )
      })}

      <!-- External Links -->
      <a href={SITE.github} target="_blank" class="nav-link">
        <Icon name="github" size={16} /> GITHUB
      </a>
    </div>
  </div>
</nav>

<script>
  let cleanupFn: (() => void) | null = null;

  function setupScrollMenu() {
    // Cleanup previous listener
    if (cleanupFn) {
      cleanupFn();
      cleanupFn = null;
    }

    const menu = document.querySelector('.floating-menu');
    if (!menu) return;

    // Detect scroll target: .content-area for DocLayout, window for others
    const contentArea = document.querySelector('.content-area');
    const scrollTarget = contentArea || window;

    // Helper to get current Scroll Y
    const getScrollY = () => contentArea ? contentArea.scrollTop : window.scrollY;

    let lastScrollY = getScrollY();

    const onScroll = () => {
      const currentScrollY = getScrollY();
      
      // Threshold validation to avoid jitter
      if (Math.abs(currentScrollY - lastScrollY) < 10) return;

      // Hide on scroll down (>50px), Show on scroll up
      // Note: We use a slightly higher threshold when inside a container 
      if (currentScrollY > 50 && currentScrollY > lastScrollY) {
        menu.classList.add('menu-hidden');
      } else {
        menu.classList.remove('menu-hidden');
      }
      
      lastScrollY = currentScrollY;
    };

    // Attach listener to the correct target
    scrollTarget.addEventListener('scroll', onScroll, { passive: true });
    
    // Store cleanup function
    cleanupFn = () => scrollTarget.removeEventListener('scroll', onScroll);
  }

  // Initialize on first load
  setupScrollMenu();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', setupScrollMenu);
</script>

<style>
  .floating-menu {
    position: fixed;
    top: 24px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    z-index: 100;
    pointer-events: none;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); /* Premium Smoothness */
  }

  .floating-menu.menu-hidden {
    transform: translateY(-150%);
  }

  .menu-pill {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(10, 10, 10, 0.8); /* Almost pure black */
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 6px; 
    border-radius: 9999px;
    box-shadow: 0 4px 40px rgba(0, 0, 0, 0.5);
    pointer-events: auto;
  }

  /* Logo */
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 15px;
    color: #fff;
    letter-spacing: -0.02em;
    text-decoration: none;
  }

  .logo-icon {
    width: 18px;
    height: 18px;
    background: linear-gradient(135deg, #3291ff, #7928ca); /* Vercel Blue/Purple */
    border-radius: 4px;
  }

  .highlight { color: #666; margin-left: 2px; }

  /* Links */
  .links {
    display: flex;
    align-items: center;
    gap: 8px; /* Compact links */
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #888;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.2s;
    padding: 0 16px;
    height: 32px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .nav-link:hover {
    color: #fff;
    background: rgba(255,255,255,0.05);
  }

  .nav-link.active {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
  }
</style>
