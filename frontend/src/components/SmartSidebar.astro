---
import { getCollection } from 'astro:content';
import Icon from './Icon.astro';

// Obtém todo o conteúdo
const allDocs = await getCollection('course');

// Função auxiliar para organizar por pastas (Módulos)
function groupByModule(docs: typeof allDocs) {
  const groups: Record<string, typeof allDocs> = {};
  
  docs.forEach(doc => {
    // Usa o campo 'module' do frontmatter (migrado) ou fallback para pasta do slug
    let groupKey = doc.data.module || 'Outros';
    
    // Fallback legado se a migração falhar (usa slug folder)
    if (!doc.data.module) {
        const [folder] = doc.slug.split('/');
        groupKey = formatTitle(folder);
    }

    if (!groups[groupKey]) groups[groupKey] = [];
    groups[groupKey].push(doc);
  });

  return groups;
}

const groupedDocs = groupByModule(allDocs);
const currentSlug = Astro.params.slug;

// Mapeamento de Ícones por Título do Módulo (Simples busca de palavra chave)
function getIconForModule(moduleTitle: string) {
    const lower = moduleTitle.toLowerCase();
    if (lower.includes('história') || lower.includes('fundamentos')) return 'book-open';
    if (lower.includes('linguagem') || lower.includes('sintaxe')) return 'code';
    if (lower.includes('hardware') || lower.includes('memória') || lower.includes('mcus')) return 'cpu';
    if (lower.includes('git')) return 'git-branch';
    if (lower.includes('segurança')) return 'shield';
    if (lower.includes('ferramentas')) return 'terminal';
    return 'folder';
}

// Helper removido: formatTitle agora é desnecessário se usarmos o module title direto
function formatTitle(folder: string) {
  const parts = folder.split('-');
  if (parts[0].match(/^\d+$/)) {
    return `Módulo ${parts[0]}: ${parts.slice(1).join(' ')}`;
  }
  return folder.charAt(0).toUpperCase() + folder.slice(1);
}
---

<aside class="sidebar">
  <!-- Header removido (Logo no FloatingMenu) -->

  <nav class="nav-scroll" id="sidebar-nav">

    {Object.entries(groupedDocs).sort((a, b) => a[0].localeCompare(b[0])).map(([moduleTitle, docs]) => {
      
      return (
        <div class="module-group">
          <div class="module-title">
            <Icon name={getIconForModule(moduleTitle)} size={14} />
            <span class="module-name">{moduleTitle}</span>
          </div>
          
          <div class="module-links">
            {docs.sort((a, b) => a.data.order - b.data.order).map(doc => {
              const isActive = currentSlug === doc.slug;
              return (
                <a 
                  href={`/course/${doc.slug}`} 
                  class:list={['link-item', { active: isActive }]}
                  data-astro-prefetch
                >
                  {doc.data.title}
                </a>
              );
            })}
          </div>
        </div>
      );
    })}
  </nav>
</aside>

<script>
  // Persist Sidebar Scroll Position
  const sidebarNav = document.getElementById('sidebar-nav');
  const STORAGE_KEY = 'sidebar-scroll-position';

  // Restore scroll on load
  document.addEventListener('astro:page-load', () => {
    const sidebarNav = document.getElementById('sidebar-nav');
    const savedPosition = sessionStorage.getItem(STORAGE_KEY);
    
    if (sidebarNav && savedPosition) {
      sidebarNav.scrollTop = parseInt(savedPosition, 10);
    }
  });

  // Save scroll before unloading or clicking links
  document.addEventListener('astro:before-preparation', () => {
    const sidebarNav = document.getElementById('sidebar-nav');
    if (sidebarNav) {
      sessionStorage.setItem(STORAGE_KEY, sidebarNav.scrollTop.toString());
    }
  });
</script>

<style>
  .sidebar {
    width: 280px;
    height: 100vh;
    background-color: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    padding-top: 32px; /* Reduced from 110px (Menu is centered, doesn't overlap) */
    z-index: 50; 
  }

  .nav-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 40px 20px;
  }

  /* Scrollbar invisível mas funcional */
  .nav-scroll::-webkit-scrollbar { width: 4px; }
  .nav-scroll::-webkit-scrollbar-thumb { background: transparent; }
  .nav-scroll:hover::-webkit-scrollbar-thumb { background: #333; }

  .home-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 40px;
    border-radius: 8px;
    transition: all 0.2s ease;
    background: rgba(255,255,255,0.02);
    border: 1px solid transparent;
  }

  .home-link:hover {
    background: rgba(255,255,255,0.05);
    color: #fff;
    border-color: rgba(255,255,255,0.05);
  }

  .module-group {
    margin-bottom: 36px;
  }

  .module-title {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 16px;
    margin-bottom: 16px;
  }

  .module-name {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-tertiary); /* Zinc 600 - Subtle */
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
  }

  .module-links {
    display: flex;
    flex-direction: column;
    gap: 4px; /* Slight gap between links */
  }

  .link-item {
    position: relative;
    display: block;
    padding: 10px 16px; 
    font-size: 14px;
    color: #888; /* Slightly darker than secondary for hierarchy */
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    border-left: 2px solid transparent; 
  }

  .link-item:hover {
    color: #fff;
    background: rgba(255,255,255, 0.03);
  }

  .link-item.active {
    color: #fff;
    background: linear-gradient(90deg, rgba(50, 145, 255, 0.1) 0%, rgba(0,0,0,0) 100%);
    border-left-color: var(--accent-blue);
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      width: 85vw; /* Almost full width for better readability on small screens */
      max-width: 320px;
      z-index: 2000; /* Above everything */
      background: var(--bg-app); /* Ensure solid background */
      padding-top: 20px;
    }
    
    /* When open */
    :global(.sidebar.mobile-open) {
      transform: translateX(0);
      box-shadow: 0 0 50px rgba(0,0,0,0.8); /* Deep shadow */
    }
    
    /* Add a backdrop when open? handled in layout or here? 
       For simplicity, we just use the shadow and click-outside logic in the menu component.
    */
  }
</style>
